package com.coffeeshop.barista.api;

import com.coffeeshop.common.utils.JsonUtil;
import com.coffeeshop.common.valueobjects.OrderUp;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.kafka.core.KafkaTemplate;

import static com.coffeeshop.common.messaging.Topics.BARISTA_IN;
import static com.coffeeshop.common.messaging.Topics.ORDERS_UP;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
class BaristaListenerTest {

    @Mock
    KafkaTemplate<String, String> kafkaTemplate;

    @InjectMocks
    BaristaListener listener;

    @Captor ArgumentCaptor<String> topicCaptor;
    @Captor ArgumentCaptor<String> keyCaptor;
    @Captor ArgumentCaptor<String> valueCaptor;

    @Test
    @DisplayName("onBaristaIn -> publishes OrderUp JSON to ORDERS_UP with orderId as key (send(topic,key,value))")
    void onBaristaIn_publishesOrderUp() {
        // Arrange
        String orderId = "order-123";
        String itemId  = "11111111-2222-3333-4444-555555555555";
        String jsonIn = """
            {
              "orderId": "%s",
              "item": "ESPRESSO",
              "name": "Alex",
              "itemId": "%s",
              "timeIn": 1756789058.77
            }
            """.formatted(orderId, itemId);

        ConsumerRecord<String, String> consumerRecord =
                new ConsumerRecord<>(BARISTA_IN, 0, 0L, orderId, jsonIn);

        // Act
        listener.onBaristaIn(consumerRecord, jsonIn);

        // Assert the 3-arg send(topic, key, value)
        verify(kafkaTemplate).send(topicCaptor.capture(), keyCaptor.capture(), valueCaptor.capture());

        assertThat(topicCaptor.getValue()).isEqualTo(ORDERS_UP);
        assertThat(keyCaptor.getValue()).isEqualTo(orderId);

        // Validate the payload JSON by deserializing to OrderUp
        OrderUp up = JsonUtil.fromJson(valueCaptor.getValue(), OrderUp.class);
        assertThat(up.orderId).isEqualTo(orderId);
        assertThat(up.itemId).isEqualTo(itemId);
        assertThat(up.item.name()).isEqualTo("ESPRESSO");
        assertThat(up.name).isEqualTo("Alex");
        assertThat(up.madeBy).isEqualTo("BaristaBot");
        assertThat(up.timeUp).isNotNull(); // generated by listener
    }
}
